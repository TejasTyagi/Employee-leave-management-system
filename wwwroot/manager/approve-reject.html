<!-- Tejas Tyagi -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Approve / Reject Leave Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Manager - Approve / Reject Leaves</span>
    </div>
</nav>

<div class="container">

    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Pending Leave Requests</h4>
            <button class="btn btn-primary" onclick="loadPending()">Refresh</button>
        </div>
    </div>

    <div id="message" class="mb-3"></div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0" id="pendingTable">
                <thead class="table-dark">
                    <tr>
                        <th>Id</th>
                        <th>Employee Id</th>
                        <th>Manager Id</th>
                        <th>Type</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const API_BASE = "http://localhost:5180/api/manager";

    function showMessage(text, isError) {
        const div = document.getElementById("message");
        if (!text) {
            div.innerHTML = "";
            return;
        }
        div.className = isError ? "alert alert-danger" : "alert alert-success";
        div.innerText = text;
    }

    function loadPending() {
        showMessage("", false);

        fetch(`${API_BASE}/pendingrequests`)
            .then(res => {
                if (!res.ok) throw new Error("Error loading pending requests");
                return res.json();
            })
            .then(data => {
                const tbody = document.querySelector("#pendingTable tbody");
                tbody.innerHTML = "";

                if (!data || data.length === 0) {
                    showMessage("No pending requests found.", false);
                    return;
                }

                data.forEach(req => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${req.id}</td>
                            <td>${req.employeeId}</td>
                            <td>${req.managerId}</td>
                            <td>${req.leaveType ?? ""}</td>
                            <td>${(req.startDate ?? "").toString().substring(0,10)}</td>
                            <td>${(req.endDate ?? "").toString().substring(0,10)}</td>
                            <td>
                                <span class="badge bg-warning text-dark">${req.status ?? ""}</span>
                            </td>
                            <td>
                                <button class="btn btn-success btn-sm me-2" onclick="approve(${req.id})">Approve</button>
                                <button class="btn btn-danger btn-sm" onclick="reject(${req.id})">Reject</button>
                            </td>
                        </tr>`;
                });
            })
            .catch(err => showMessage(err.message, true));
    }

    function approve(id) {
        fetch(`${API_BASE}/approve/${id}`, { method: "PUT" })
            .then(res => {
                if (!res.ok) throw new Error("Error approving request");
                showMessage(`Request ${id} approved.`, false);
                loadPending();
            })
            .catch(err => showMessage(err.message, true));
    }

    function reject(id) {
        fetch(`${API_BASE}/reject/${id}`, { method: "PUT" })
            .then(res => {
                if (!res.ok) throw new Error("Error rejecting request");
                showMessage(`Request ${id} rejected.`, false);
                loadPending();
            })
            .catch(err => showMessage(err.message, true));
    }

    window.onload = loadPending;
</script>

</body>
</html>
